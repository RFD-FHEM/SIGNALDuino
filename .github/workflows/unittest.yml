name: unittest
on:
  release:
    types: [created, prereleased, published]
  workflow_dispatch: null
  push: null

jobs:
  unittest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with: 
          submodules: true

      - uses: lukka/get-cmake@v3.26.1
        with:
          cmakeVersion: "~3.25.0"  # <--= optional, use most recent 3.25.x version

      - name: prepare directory
        working-directory: ./tests
        run:  mkdir -p build

      - uses: actions/cache@v3
        with:
          path: |
            ./tests/build/_deps/
          key: cmake-deps
      
      - name: cmake prepareBuild
        working-directory: ./tests/build
        run: cmake -DCMAKE_BUILD_TYPE=Release ..

      - name: cmake build (compile) project
        working-directory: ./tests/build
        run: cmake --build .

      - name: run ctest
        working-directory: ./tests/build
        run: ctest  -V


  build:
    needs: unittest
    strategy:
      fail-fast: false
      matrix:
        include:
          - envName: nano_bootl_new
          - envName: nano_bootl_new_CC1101
          - envName: nano_bootl_old
          - envName: nano_bootl_old_CC1101
          - envName: radino_CC1101
          - envName: wemos_d1_mini_pro_CC1101
          - envName: wemos_d1_mini_pro
          - envName: pro_promini_16MHz
          - envName: pro_promini_16MHz_CC1101
          - envName: pro_promini_8MHz
          - envName: pro_promini_8MHz_CC1101
          - envName: esp32
          - envName: esp32_CC1101
          - envName: esp8266
          - envName: esp8266_CC1101
          - envName: maple_mini_bootl_v1_CC1101
          - envName: maple_mini_bootl_v1

    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with: 
          submodules: true
          fetch-depth: 0

      - name: Extract branch name
        shell: bash
        run: echo "gh_branch_name=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_ENV
        id: extract_branch
        
      - uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.platformio/.cache
          key: ${{ matrix.envName }}-pio
      
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install PlatformIO Core
        run: pip install --upgrade platformio
        
      - name: Run PlatformIO and compile sketch
        id: compile_sketch
        run: |
          export COMPILE_OUTPUT=$(pio run -e ${{ matrix.envName }} )
          echo "$COMPILE_OUTPUT"
          FILEEXT=$(find .pio/build/${{ matrix.envName }} -maxdepth 1 \( -name 'SIGNALduino*.bin' -o -name 'SIGNALduino*.hex' \) | while read file; do echo "${file##*.}"; done)
          echo "Extension: $FILEEXT"
          echo "FILEEXT=$(echo $FILEEXT | tr -d '\n')" >> $GITHUB_OUTPUT
          echo "SKETCHSIZE=$(echo "$COMPILE_OUTPUT" | grep -Po "(^Flash: ).*")" >> $GITHUB_OUTPUT
          echo "GLOBALRAMUSAGE=$(echo "$COMPILE_OUTPUT" | grep -Po "(^RAM: ).*")" >> $GITHUB_OUTPUT

      - name: Create Job Summary
        run: |
          echo "### Size report for commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "| ENV | Flash | Ram |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ${{ matrix.envName }} | ${{ steps.compile_sketch.outputs.SKETCHSIZE }} | ${{ steps.compile_sketch.outputs.GLOBALRAMUSAGE }} |" >> $GITHUB_STEP_SUMMARY

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: SIGNALduino_${{ matrix.envName }}.${{ steps.compile_sketch.outputs.FILEEXT }}
          path: |
            .pio/build/${{ matrix.envName }}/SIGNALduino*.${{ steps.compile_sketch.outputs.FILEEXT }}
          if-no-files-found: warn
  release:
    needs: build
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: Download artifact
        id: download
        uses: actions/download-artifact@v3

      - name: 'Echo download path'
        run: ls -R ${{steps.download.outputs.download-path}}

      - name: Upload Release Asset
        id: upload-release-asset 
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          draft: true
          files: |
            ${{steps.download.outputs.download-path}}/SIGNALduino*/SIGNALduino*